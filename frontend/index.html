<!DOCTYPE html>
<html>
  <head>
    <title>Help Forum</title>

    <link rel="stylesheet" href="styles/styles.css" />
  </head>

  <body>
    <div class="container">
      <h1>Help Forum</h1>
      <div class="row">
        <div class="card card--question">
          <h2>Question</h2>
          <div class="form-group">
            <label for="askquestion">Subject</label>
            <input
              type="text"
              id="askquestion"
              name="askquestion"
              placeholder="Question Subject"
              oninput="onQuestionInputChange()"
            />
          </div>
          <div class="form-group">
            <label for="question-body">Body</label>
            <textarea type="text" id="question-body" name="question-body" placeholder="Question Body"></textarea>
          </div>
          <div class="form-group form-group--inline">
            <button class="btn btn--green push-right" onclick="submitQuestion()">Submit</button>
          </div>
        </div>
        <div class="card card--suggestions">
          <h2>Suggestions</h2>
          <div id="suggestions"></div>
        </div>
      </div>
    </div>
    <div class="modal" id="question-modal" onclick="closeModal()">
      <div class="modal--content" onclick="event.stopPropagation()">
        <div class="modal--heading">
          <h2 id="question-modal--subject">How do I use pointers?</h2>
        </div>
        <div class="modal--body">
          <p id="question-modal--body">
            My Modal body! Lorem ipsum dolor sit, amet consectetur adipisicing elit. Doloremque assumenda earum sit
            veritatis ratione officiis velit nemo incidunt doloribus vero, aspernatur in eligendi corporis amet iusto
            fugiat quasi consequuntur sapiente hic tenetur eius dolore deserunt dolores voluptatibus! Voluptatum fugit
            nostrum inventore. Minus dicta quaerat nesciunt quisquam vitae enim, aspernatur inventore?
          </p>
        </div>
        <div class="modal--footer">
          <div class="form-group form-group--inline">
            <button class="btn btn--green" onclick="">View answers</button>
            <button class="btn push-right" onclick="closeModal()">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      const newQuestionSubjectElement = document.getElementById("askquestion");
      const newQuestionBodyElement = document.getElementById("question-body");

      const suggestionCardElement = document.getElementById("suggestions");

      const modalElement = document.getElementById("question-modal");
      const modalSubjectElement = document.getElementById("question-modal--subject");
      const modalBodyElement = document.getElementById("question-modal--body");

      async function onSuggestionClick(suggestionSubject) {
        const res = await fetch(`/api/question/get/${encodeURIComponent(suggestionSubject)}`);

        if (!res.ok) {
          return;
        }

        const data = await res.json();

        modalSubjectElement.innerHTML = data.subject;
        modalBodyElement.innerHTML = data.body;

        openModal();
      }

      let fetchSuggestionsTimeout = null;

      async function fetchSuggestions() {
        const questionSubject = newQuestionSubjectElement.value || "Help";

        const res = await fetch(`/api/suggestion/${encodeURIComponent(questionSubject)}`);

        if (!res.ok) {
          return;
        }

        const data = await res.json();

        const matches = data.matches;

        suggestionCardElement.innerHTML = "";

        const num = 10;
        for (let i = 0; i < num; i++) {
          let suggestionElement = document.createElement("div");
          suggestionElement.innerHTML = matches[i].question;
          suggestionElement.classList.add("suggestion");
          suggestionElement.onclick = () => onSuggestionClick(matches[i].question);

          suggestionCardElement.appendChild(suggestionElement);
        }
      }

      function onQuestionInputChange() {
        if (fetchSuggestionsTimeout) {
          clearTimeout(fetchSuggestionsTimeout);
        }

        fetchSuggestionsTimeout = setTimeout(fetchSuggestions, 190);
      }

      fetchSuggestions();

      function openModal() {
        modalElement.style.display = "flex";
      }

      function closeModal() {
        modalElement.style.display = "none";
      }

      async function submitQuestion() {
        const res = await fetch(`/api/question/new`, {
          method: "POST",
          body: JSON.stringify({
            subject: newQuestionSubjectElement.value,
            body: newQuestionBodyElement.value,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (!res.ok) {
          return;
        }

        console.log(await res.text());
      }
    </script>
  </body>
</html>
